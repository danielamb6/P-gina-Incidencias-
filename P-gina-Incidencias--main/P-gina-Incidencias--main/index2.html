<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Reportes de Incidencias</title>
    
    <script>
        if (!localStorage.getItem('sesion')) {
            window.location.href = "login.html";
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-placeholder" id="logo-placeholder">
                <i class="fas fa-tools"></i>
            </div>
            <img src="logo sin fondo.png" alt="Logo del Sistema" class="logo-img" onerror="document.getElementById('logo-placeholder').style.display='flex'; this.style.display='none'">            
            <div class="logo-text">
                <h1>Sistema de <span>Incidencias</span></h1>
                <div class="subtitle">Panel de Administración</div>
            </div>
        </div>

        <div class="top-user-info">
            <div class="user-details">
                <span id="display-user-name" style="font-weight: bold; color: var(--primary-blue);">Cargando...</span>
                <small id="display-user-role" style="display: block; color: var(--text-light); font-size: 0.75rem; text-align: right;">...</small>
            </div>
            
            <button id="btn-logout" style="background: var(--accent-color); color: white; margin-left: 15px; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; transition: transform 0.2s;">
                <i class="fas fa-power-off"></i> Salir
            </button>

            <div class="top-user-avatar" data-tooltip="Usuario">AD</div>
        </div>
    </div>

    <div class="container">
        <aside class="sidebar">
            <div class="logo-sidebar">
                <h2>Admin<span>Incidencias</span></h2>
                <p>Sistema de Gestión</p>
            </div>
            <ul class="menu">
                <li class="menu-item">
                    <a href="#" class="menu-link active" id="nav-dashboard">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                        
                    </a>
                </li>
                <li class="menu-item">
                    <a href="registro_usuario.html" class="menu-link">
                        <i class="fas fa-user-plus"></i>
                        <span>Registro Usuarios</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" id="nav-gestion-tecnica">
                        <i class="fas fa-cogs"></i>
                        <span>Gestión Técnica</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" id="nav-incidencias">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Incidencias</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" id="nav-tecnicos">
                        <i class="fas fa-users"></i>
                        <span>Técnicos</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" id="nav-empresas">
                        <i class="fas fa-building"></i>
                        <span>Empresas</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" id="nav-reportes">
                        <i class="fas fa-file-export"></i>
                        <span>Reportes</span>
                    </a>
                </li>
            </ul>
        </aside>

        <main class="main-content">
            
            <div id="view-dashboard">
                <h1 class="page-title">
                    <i class="fas fa-chart-bar"></i>
                    Reportes de Incidencias
                </h1>

                <section class="filters">
                    <h2><i class="fas fa-filter"></i> Filtrar Reporte</h2>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="empresa"><i class="fas fa-building"></i> Empresa</label>
                            <select id="empresa" class="filter-control">
                                <option value="">Todas las empresas</option>
                                <option value="zoxo">Zoxo</option>
                                <option value="codiversa">Codiversa</option>
                                <option value="copesa">Copesa</option>
                                <option value="sitraq">Sitraq</option>
                                <option value="corevsa">Corevsa</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="tecnico"><i class="fas fa-user-cog"></i> Técnico</label>
                            <select id="tecnico" class="filter-control">
                                <option value="">Todos los técnicos</option>                       
                                <option value="juan_perez">Juan Pérez</option>
                                <option value="maria_gomez">María Gómez</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="tipo-falla"><i class="fas fa-tools"></i> Tipo de Falla</label>
                            <select id="tipo-falla" class="filter-control">
                                <option value="">Todos los tipos</option>
                                <option value="equipos">Equipos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="estado"><i class="fas fa-clipboard-check"></i> Estado</label>
                            <select id="estado" class="filter-control">
                                <option value="">Todos los estados</option>
                                <option value="abierto">Abierto</option>
                                <option value="espera">En Espera</option>
                                <option value="cerrado">Cerrado</option>
                                <option value="resuelto">Resuelto</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="fecha-inicio"><i class="fas fa-calendar-alt"></i> Rango de Fechas</label>
                            <div class="date-range">
                                <input type="date" id="fecha-inicio" class="filter-control" style="flex: 1;">
                                <input type="date" id="fecha-fin" class="filter-control" style="flex: 1;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-secondary" id="limpiar-filtros">
                            <i class="fas fa-eraser"></i> Limpiar Filtros
                        </button>
                        <button class="btn btn-pdf" id="generar-pdf">
                            <i class="fas fa-file-pdf"></i> Vista Previa PDF
                        </button>
                    </div>
                </section>

                <section class="data-summary">
                    <div class="summary-card">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3 id="total-incidencias">48</h3>
                        <p>Incidencias Totales</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-user-cog"></i>
                        <h3 id="active-tecnicos-count">12</h3>
                        <p>Técnicos Activos</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-building"></i>
                        <h3 id="active-empresas-count">5</h3>
                        <p>Empresas Activas</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-folder-open"></i>
                        <h3 id="abiertas-count">15</h3>
                        <p>Incidencias Abiertas</p>
                    </div>
                    <div class="summary-card" style="border-left: 4px solid var(--warning);">
                        <i class="fas fa-hourglass-half" style="color: var(--warning);"></i>
                        <h3 id="espera-count">8</h3>
                        <p>En Espera de Refacción</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-check-circle"></i>
                        <h3 id="cerradas-count">25</h3>
                        <p>Incidencias Cerradas</p>
                    </div>
                </section>

                <section class="table-preview">
                    <h2><i class="fas fa-table"></i> Vista Previa del Reporte</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Técnico</th>
                                <th>Fecha</th>
                                <th>Empresa</th>
                                <th>Tiempo</th>
                                <th>Tipo de Falla</th>
                                <th>Estado</th>
                                <th>Acciones</th> </tr>
                        </thead>
                        <tbody id="tickets-body">
                            </tbody>
                    </table>
                </section>
            </div>

            <div id="view-gestion-tecnica" style="display: none;">
                <h1 class="page-title">
                    <i class="fas fa-cogs"></i> Gestión Técnica
                </h1>
                
                <div class="tech-container">
                    <div class="tech-tabs">
                        <button class="tech-tab active" onclick="cambiarTab('tab-equipos')">Equipos</button>
                        <button class="tech-tab" onclick="cambiarTab('tab-elementos')">Elementos</button>
                        <button class="tech-tab" onclick="cambiarTab('tab-fallas')">Falla Reportada</button>
                        <button class="tech-tab" onclick="cambiarTab('tab-accesorios')">Accesorios</button>
                        <button class="tech-tab" onclick="cambiarTab('tab-revision')">Detalle Revisión</button>
                        <button class="tech-tab" onclick="cambiarTab('tab-solucion')">Solución</button>
                    </div>

                    <div class="tech-content-area">
                        <div class="actions-bar admin-only" style="margin-bottom:15px; text-align:right;">
                            <button class="btn btn-primary" onclick="abrirModalAgregar('catalogo')">
                                <i class="fas fa-plus"></i> Agregar Nuevo
                            </button>
                        </div>

                        <div id="tab-equipos" class="tab-content active"><div class="table-preview"><table><thead><tr><th>Nombre</th><th class="col-accion">Acciones</th></tr></thead><tbody id="body-equipos"></tbody></table></div></div>
                        <div id="tab-elementos" class="tab-content"><div class="table-preview"><table><thead><tr><th>Nombre</th><th class="col-accion">Acciones</th></tr></thead><tbody id="body-elementos"></tbody></table></div></div>
                        <div id="tab-fallas" class="tab-content"><div class="table-preview"><table><thead><tr><th>Descripción</th><th class="col-accion">Acciones</th></tr></thead><tbody id="body-fallas"></tbody></table></div></div>
                        <div id="tab-accesorios" class="tab-content"><div class="table-preview"><table><thead><tr><th>Nombre</th><th class="col-accion">Acciones</th></tr></thead><tbody id="body-accesorios"></tbody></table></div></div>
                        <div id="tab-revision" class="tab-content"><div class="table-preview"><table><thead><tr><th>Detalle</th><th class="col-accion">Acciones</th></tr></thead><tbody id="body-revision"></tbody></table></div></div>
                        <div id="tab-solucion" class="tab-content"><div class="table-preview"><table><thead><tr><th>Solución</th><th class="col-accion">Acciones</th></tr></thead><tbody id="body-solucion"></tbody></table></div></div>
                    </div>
                </div>
            </div>

            <div id="view-incidencias" style="display: none;">
                <h1 class="page-title"><i class="fas fa-exclamation-circle"></i> Todas las Incidencias</h1>
                <div class="table-preview">
                    <table>
                        <thead><tr><th>ID</th><th>Técnico</th><th>Empresa</th><th>Tipo de Falla</th><th>Fecha</th><th>Estado</th></tr></thead>
                        <tbody id="all-tickets-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-tecnicos" style="display: none;">
                <h1 class="page-title">
                    <i class="fas fa-users"></i> Listado de Técnicos
                </h1>
                
                <h3 style="margin-bottom: 15px; color: var(--primary-blue);">Resumen de Actividad</h3>
                <div class="data-summary" id="tecnicos-list-container" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); margin-bottom: 30px;">
                    </div>

                <div class="table-container">
                    <div class="table-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: var(--primary-blue); margin: 0;"><i class="fas fa-list"></i> Gestión Detallada de Técnicos</h3>
                        <button class="btn btn-primary admin-only" onclick="abrirModalAgregar('tecnico')">
                            <i class="fas fa-user-plus"></i> Agregar Técnico
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Estado</th>
                                <th class="col-accion">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-gestion-tecnicos">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="view-empresas" style="display: none;">
                <h1 class="page-title">
                    <i class="fas fa-building"></i> Empresas Registradas
                </h1>

                <h3 style="margin-bottom: 15px; color: var(--primary-blue);">Resumen de Reportes</h3>
                <div class="data-summary" id="empresas-list-container" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); margin-bottom: 30px;">
                    </div>

                <div class="table-container">
                    <div class="table-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: var(--primary-blue); margin: 0;"><i class="fas fa-list"></i> Gestión Detallada de Empresas</h3>
                        <button class="btn btn-primary admin-only" onclick="abrirModalAgregar('empresa')">
                            <i class="fas fa-plus"></i> Agregar Empresa
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Empresa</th>
                                <th>Estado</th>
                                <th class="col-accion">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-gestion-empresas">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="view-reportes" style="display: none;">
                <h1 class="page-title">
                    <i class="fas fa-file-export"></i> Historial de Reportes
                </h1>
                <div class="table-preview">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre del Reporte</th>
                                <th>Fecha Generación</th>
                                <th>Hora</th> <th>Periodo Analizado</th>
                                <th>Usuario Generador</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="reportes-history-body">
                            </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div class="modal" id="modal-agregar-generico">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-titulo"><i class="fas fa-plus-circle"></i> Agregar</h2>
                <button class="close-modal" onclick="cerrarModalAgregar()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label id="modal-label">Nombre</label>
                    <input type="text" id="input-agregar-nombre" class="filter-control" style="width:100%" placeholder="Escriba aquí...">
                </div>
                <div style="margin-top:20px; text-align:right;">
                    <button class="btn btn-secondary" onclick="cerrarModalAgregar()">Cancelar</button>
                    <button class="btn btn-primary" onclick="guardarNuevoGenerico()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="pdf-preview-modal"><div class="modal-content"><div class="modal-header"><button class="close-modal" id="close-modal">&times;</button></div><div id="pdf-content"></div></div></div>

    <script src="Administrador.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const sesion = localStorage.getItem('sesion');
        if (!sesion) { window.location.href = "login.html"; return; }
        const datos = JSON.parse(sesion);
        document.getElementById('display-user-name').textContent = datos.nombre;
        document.getElementById('display-user-role').textContent = datos.rol.toUpperCase();
        
        // Control de visibilidad por rol (Admin vs Supervisor) en el HTML
        if (datos.rol.toLowerCase() !== 'administrador') {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        }

        document.getElementById('btn-logout').addEventListener('click', function() {
            localStorage.removeItem('sesion');
            window.location.href = "login.html";
        });
    });
    </script>
</body>       
</html>